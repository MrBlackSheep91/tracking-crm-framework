{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "visitor-processor",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "d6fb6b41-7064-46b5-ae13-45d34889935e",
      "name": "Webhook Visitor Tracking",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -656,
        -32
      ],
      "webhookId": "visitor-tracking-v3"
    },
    {
      "parameters": {
        "jsCode": "// 🔍 VISITOR TRACKING PROCESSOR v3.2 - MAPEO CORREGIDO\n// Procesa payload REAL según estructura exacta proporcionada\n\nconst payload = $input.first().json.body.body; // Doble .body según estructura real\n\nconsole.log('🔍 === VISITOR PROCESSOR v3.2 (MAPEO CORREGIDO) ===');\nconsole.log('📥 Payload completo:', JSON.stringify(payload, null, 2));\n\n// ⚠️ VALIDACIONES INICIALES\nif (!payload) {\n  console.error('❌ Payload vacío o nulo');\n  return {\n    json: {\n      error: 'Empty or null payload',\n      success: false\n    }\n  };\n}\n\nconst session = payload.session || {};\nconst events = payload.events || [];\n\n// Validar campos críticos usando estructura REAL\nif (!session.sessionId) {\n  console.error('❌ Session ID faltante en session.sessionId');\n  return {\n    json: {\n      error: 'Missing session.sessionId',\n      success: false\n    }\n  };\n}\n\nif (!session.visitorId) {\n  console.error('❌ Visitor ID faltante en session.visitorId');\n  return {\n    json: {\n      error: 'Missing session.visitorId',\n      success: false\n    }\n  };\n}\n\nconsole.log(`🔗 Processing session: ${session.sessionId}`);\nconsole.log(`👤 Processing visitor: ${session.visitorId}`);\nconsole.log(`📊 Events count: ${events.length}`);\n\n// 📊 CALCULAR DURACIÓN DE SESIÓN\nconst startTime = new Date(session.startedAt);\nconst endTime = new Date(session.endedAt);\nconst sessionDuration = endTime - startTime; // en milisegundos\n\n// 📊 EXTRACT & NORMALIZE SESSION DATA - USANDO ESTRUCTURA REAL\nconst sessionData = {\n  id: session.sessionId,\n  businessId: session.businessId || '00000000-0000-0000-0000-000000000001',\n  visitorId: session.visitorId,\n  fingerprint: session.fingerprint,\n  pageUrl: session.pageInfo?.url,\n  pageTitle: session.pageInfo?.title,\n  deviceInfo: {\n    userAgent: session.deviceInfo?.userAgent,\n    deviceType: session.deviceInfo?.type,\n    browser: session.deviceInfo?.browser,\n    operatingSystem: session.deviceInfo?.os,\n    language: session.deviceInfo?.language,\n    timezone: session.deviceInfo?.timezone,\n    screenResolution: session.deviceInfo?.screenResolution,\n    viewportSize: session.deviceInfo?.viewportSize\n  },\n  location: {\n    ipAddress: session.ipLocation?.ip,\n    country: session.ipLocation?.country,\n    region: session.ipLocation?.region,\n    city: session.ipLocation?.city,\n    latitude: session.ipLocation?.latitude,\n    longitude: session.ipLocation?.longitude,\n    timezone: session.ipLocation?.timezone\n  },\n  attribution: {\n    referrer: session.pageInfo?.referrer || session.userBehavior?.referrer || 'direct',\n    source: 'direct', // TODO: extraer de UTM params si existen\n    medium: 'none',   // TODO: extraer de UTM params si existen\n    campaign: null,   // TODO: extraer de UTM params si existen\n    content: null,\n    term: null,\n    fbclid: null\n  },\n  timing: {\n    startTime: session.startedAt,\n    endTime: session.endedAt,\n    duration: sessionDuration,\n    lastActivity: session.endedAt\n  }\n};\n\n// 👤 EXTRACT & NORMALIZE VISITOR DATA\nconst visitorData = {\n  id: session.visitorId,\n  businessId: session.businessId || '00000000-0000-0000-0000-000000000001',\n  fingerprint: session.fingerprint,\n  isNewVisitor: true, // TODO: determinar si es nuevo visitante\n  totalVisits: 1, // TODO: calcular visitas totales\n  totalPageViews: events.filter(e => e.eventType === 'session_event').length || 1,\n  avgTimeOnSite: sessionDuration,\n  score: 0,\n  isIdentified: false,\n  leadId: null,\n  contactId: null\n};\n\n// 🎯 DETECT CONVERSION EVENTS (USANDO ESTRUCTURA REAL)\nconst hasConversion = events.some(event => \n  event.eventType === 'user_interaction' && \n  (event.metadata?.category === 'form' || \n   event.metadata?.elementText?.toLowerCase().includes('comprar') ||\n   event.metadata?.elementText?.toLowerCase().includes('quiero') ||\n   event.metadata?.elementText?.toLowerCase().includes('solicitar') ||\n   event.metadata?.actionType === 'form_submit' ||\n   (event.metadata?.actionType === 'click' && event.metadata?.category === 'form'))\n);\n\n// 📊 CALCULATE ENGAGEMENT METRICS\nconst interactionEvents = events.filter(e => e.eventType === 'user_interaction').length;\nconst activityEvents = events.filter(e => e.eventType === 'user_activity').length;\nconst engagementScore = \n  (events.length * 2) + \n  (sessionDuration > 30000 ? 10 : 0) + \n  (hasConversion ? 20 : 0) + \n  (interactionEvents * 3) + \n  (activityEvents * 1);\n\n// 📋 STRUCTURE FINAL RESULT\nconst result = {\n  session: sessionData,\n  visitor: {\n    ...visitorData,\n    engagementScore: engagementScore\n  },\n  events: events,\n  hasConversion: hasConversion,\n  metrics: {\n    totalEvents: events.length,\n    interactionEvents: interactionEvents,\n    activityEvents: activityEvents,\n    sessionDuration: sessionDuration,\n    engagementLevel: engagementScore > 50 ? 'high' : engagementScore > 25 ? 'medium' : 'low'\n  },\n  originalPayload: payload,\n  processedAt: new Date().toISOString()\n};\n\nconsole.log('✅ Procesamiento exitoso (MAPEO CORREGIDO):');\nconsole.log(`  - Session: ${sessionData.id}`);\nconsole.log(`  - Visitor: ${visitorData.id}`);\nconsole.log(`  - Events: ${events.length}`);\nconsole.log(`  - Has Conversion: ${hasConversion}`);\nconsole.log(`  - Engagement Score: ${engagementScore}`);\nconsole.log(`  - Session Duration: ${sessionDuration}ms`);\n\nreturn { json: result };"
      },
      "id": "9af3f812-a713-4af9-9101-4ae378f4cb6e",
      "name": "Process Visitor Data (Fixed)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -384,
        -32
      ]
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": "visitors",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.visitor.id }}",
            "businessId": "={{ $json.visitor.businessId }}",
            "fingerprint": "={{ $json.visitor.fingerprint }}",
            "firstVisitAt": "={{ $json.visitor.isNewVisitor ? $now : null }}",
            "lastVisitAt": "={{ $now }}",
            "totalVisits": "={{ $json.visitor.isNewVisitor ? 1 : ($json.visitor.totalVisits || 0) + 1 }}",
            "totalPageViews": "={{ $json.visitor.totalPageViews }}",
            "avgTimeOnSite": "={{ $json.visitor.avgTimeOnSite }}",
            "firstUserAgent": "={{ $json.visitor.isNewVisitor ? $json.session.deviceInfo.userAgent : null }}",
            "firstDeviceType": "={{ $json.visitor.isNewVisitor ? $json.session.deviceInfo.deviceType : null }}",
            "firstBrowser": "={{ $json.visitor.isNewVisitor ? $json.session.deviceInfo.browser : null }}",
            "firstOs": "={{ $json.visitor.isNewVisitor ? $json.session.deviceInfo.operatingSystem : null }}",
            "firstSource": "={{ $json.visitor.isNewVisitor ? $json.session.attribution.source : null }}",
            "firstMedium": "={{ $json.visitor.isNewVisitor ? $json.session.attribution.medium : null }}",
            "firstCampaign": "={{ $json.visitor.isNewVisitor ? $json.session.attribution.campaign : null }}",
            "firstContent": "={{ $json.visitor.isNewVisitor ? $json.session.attribution.content : null }}",
            "firstTerm": "={{ $json.visitor.isNewVisitor ? $json.session.attribution.term : null }}",
            "isIdentified": "={{ $json.visitor.isIdentified }}",
            "leadId": "={{ $json.visitor.leadId }}",
            "contactId": "={{ $json.visitor.contactId }}",
            "score": "={{ $json.visitor.engagementScore }}",
            "createdAt": "={{ $json.visitor.isNewVisitor ? $now : null }}",
            "updatedAt": "={{ $now }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": true,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "businessId",
              "displayName": "businessId",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "fingerprint",
              "displayName": "fingerprint",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "firstVisitAt",
              "displayName": "firstVisitAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "lastVisitAt",
              "displayName": "lastVisitAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "totalVisits",
              "displayName": "totalVisits",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "totalPageViews",
              "displayName": "totalPageViews",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "avgTimeOnSite",
              "displayName": "avgTimeOnSite",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "firstUserAgent",
              "displayName": "firstUserAgent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "firstDeviceType",
              "displayName": "firstDeviceType",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "firstBrowser",
              "displayName": "firstBrowser",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "firstOs",
              "displayName": "firstOs",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "firstCampaign",
              "displayName": "firstCampaign",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "firstSource",
              "displayName": "firstSource",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "firstMedium",
              "displayName": "firstMedium",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "firstContent",
              "displayName": "firstContent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "firstTerm",
              "displayName": "firstTerm",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "isIdentified",
              "displayName": "isIdentified",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "leadId",
              "displayName": "leadId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "contactId",
              "displayName": "contactId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "score",
              "displayName": "score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "createdAt",
              "displayName": "createdAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "updatedAt",
              "displayName": "updatedAt",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "a287cdb0-4bdc-4a9c-856b-51dc884b1d28",
      "name": "Save Visitor",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -128,
        -224
      ],
      "credentials": {
        "postgres": {
          "id": "V6Wg0EpZSpeIWJlp",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "cc0293ed-767b-4d82-afaf-e5c0f68d053a",
              "leftValue": "={{ $json.hasConversion }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "1ee5b78d-3a83-4ba1-a77e-40d6a236a525",
      "name": "Check Conversion",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -32,
        -32
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": true,\n  \"message\": \"Visitor session processed successfully\",\n  \"data\": {\n    \"sessionId\": $json.session.id,\n    \"visitorId\": $json.visitor.id,\n    \"isNewVisitor\": $json.visitor.isNewVisitor,\n    \"hasConversion\": $json.hasConversion,\n    \"eventsProcessed\": $json.events.length,\n    \"processedAt\": $json.processedAt\n  }\n} }}",
        "options": {}
      },
      "id": "c67f6955-d0bc-4fe0-8f7f-66e7f3a2cdd0",
      "name": "Response Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        576,
        -32
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "KeUxO1TXQVBYzLSo",
          "mode": "list",
          "cachedResultName": "04-ACTIVITY-LOGGER"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        256,
        80
      ],
      "id": "2e57b88c-08d7-4254-84f2-c46505a323e1",
      "name": "Log Session Activity"
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": "visitor_sessions",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.session.id }}",
            "businessId": "={{ $json.session.businessId }}",
            "visitorId": "={{ $json.session.visitorId }}",
            "startedAt": "={{ $json.session.timing.startTime }}",
            "endedAt": "={{ $json.session.timing.endTime }}",
            "duration": "={{ $json.session.timing.duration }}",
            "userAgent": "={{ $json.session.deviceInfo.userAgent }}",
            "deviceType": "={{ $json.session.deviceInfo.deviceType }}",
            "browser": "={{ $json.session.deviceInfo.browser }}",
            "browserVersion": "={{ null }}",
            "operatingSystem": "={{ $json.session.deviceInfo.operatingSystem }}",
            "osVersion": "={{ null }}",
            "screenResolution": "={{ $json.session.deviceInfo.screenResolution }}",
            "screenSize": "={{ $json.session.deviceInfo.viewportSize }}",
            "timezone": "={{ $json.session.deviceInfo.timezone }}",
            "language": "={{ $json.session.deviceInfo.language }}",
            "ipAddress": "={{ $json.session.location.ipAddress }}",
            "country": "={{ $json.session.location.country }}",
            "region": "={{ $json.session.location.region }}",
            "city": "={{ $json.session.location.city }}",
            "latitude": "={{ $json.session.location.latitude }}",
            "longitude": "={{ $json.session.location.longitude }}",
            "entryUrl": "={{ $json.session.pageUrl }}",
            "exitUrl": "={{ $json.session.pageUrl }}",
            "pagesViewed": "={{ $json.events.length }}",
            "referrer": "={{ $json.session.attribution.referrer }}",
            "utmSource": "={{ $json.session.attribution.source }}",
            "utmMedium": "={{ $json.session.attribution.medium }}",
            "utmCampaign": "={{ $json.session.attribution.campaign }}",
            "utmContent": "={{ $json.session.attribution.content }}",
            "utmTerm": "={{ $json.session.attribution.term }}",
            "fbclid": "={{ $json.session.attribution.fbclid }}",
            "gclid": "={{ null }}",
            "aiAnalysis": "={{ null }}",
            "createdAt": "={{ $now }}",
            "updatedAt": "={{ $now }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": true,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "visitorId",
              "displayName": "visitorId",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "businessId",
              "displayName": "businessId",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "startedAt",
              "displayName": "startedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "endedAt",
              "displayName": "endedAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "duration",
              "displayName": "duration",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "userAgent",
              "displayName": "userAgent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "deviceType",
              "displayName": "deviceType",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "browser",
              "displayName": "browser",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "browserVersion",
              "displayName": "browserVersion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "operatingSystem",
              "displayName": "operatingSystem",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "osVersion",
              "displayName": "osVersion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "screenResolution",
              "displayName": "screenResolution",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "screenSize",
              "displayName": "screenSize",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "timezone",
              "displayName": "timezone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "language",
              "displayName": "language",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "ipAddress",
              "displayName": "ipAddress",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "country",
              "displayName": "country",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "region",
              "displayName": "region",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "city",
              "displayName": "city",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "latitude",
              "displayName": "latitude",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "longitude",
              "displayName": "longitude",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "entryUrl",
              "displayName": "entryUrl",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "exitUrl",
              "displayName": "exitUrl",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "pagesViewed",
              "displayName": "pagesViewed",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "referrer",
              "displayName": "referrer",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "utmSource",
              "displayName": "utmSource",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "utmMedium",
              "displayName": "utmMedium",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "utmCampaign",
              "displayName": "utmCampaign",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "utmContent",
              "displayName": "utmContent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "utmTerm",
              "displayName": "utmTerm",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "fbclid",
              "displayName": "fbclid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "gclid",
              "displayName": "gclid",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "aiAnalysis",
              "displayName": "aiAnalysis",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "createdAt",
              "displayName": "createdAt",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "updatedAt",
              "displayName": "updatedAt",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "f77e2b0f-b263-4a49-b2e0-3db7da3367de",
      "name": "Save Session",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        -128,
        160
      ],
      "credentials": {
        "postgres": {
          "id": "V6Wg0EpZSpeIWJlp",
          "name": "PostgreSQL"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "NgpadQbLoNpV5ouM",
          "mode": "list",
          "cachedResultName": "02-CONVERSION-DETECTOR"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        256,
        -160
      ],
      "id": "7604cd25-c759-4836-bd63-61e8486e3661",
      "name": "Trigger Conversion Detector"
    }
  ],
  "connections": {
    "Webhook Visitor Tracking": {
      "main": [
        [
          {
            "node": "Process Visitor Data (Fixed)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Visitor Data (Fixed)": {
      "main": [
        [
          {
            "node": "Save Visitor",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check Conversion",
            "type": "main",
            "index": 0
          },
          {
            "node": "Save Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Conversion": {
      "main": [
        [
          {
            "node": "Trigger Conversion Detector",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Session Activity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Session Activity": {
      "main": [
        [
          {
            "node": "Response Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger Conversion Detector": {
      "main": [
        [
          {
            "node": "Response Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {
    "Webhook Visitor Tracking": [
      {
        "headers": {
          "accept": "application/json, text/plain, */*",
          "content-type": "application/json",
          "user-agent": "axios/1.11.0",
          "content-length": "5802",
          "accept-encoding": "gzip, compress, deflate, br",
          "host": "n8n:5678",
          "connection": "close"
        },
        "params": {},
        "query": {},
        "body": {
          "body": {
            "session": {
              "sessionId": "6b421ec7-ce3f-4bbe-8bde-99e3412fa4ca",
              "visitorId": "3fe4bf35-30d4-44fc-b5f9-057eb1acdce8",
              "businessId": "00000000-0000-0000-0000-000000000001",
              "fingerprint": "fp_67187c3e",
              "startedAt": "2025-07-24T23:30:38.087Z",
              "endedAt": "2025-07-24T23:30:53.100Z",
              "deviceInfo": {
                "type": "desktop",
                "os": "Windows",
                "browser": "Edge",
                "screenResolution": "1920x1080",
                "viewportSize": "1865x956",
                "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/139.0.0.0 Safari/537.36 Edg/139.0.0.0",
                "language": "en",
                "timezone": "America/Buenos_Aires"
              },
              "ipLocation": {
                "ip": "2800:a4:24f8:5a00:86e:2046:1e14:cc1a",
                "country": "Uruguay",
                "region": "Maldonado",
                "city": "Maldonado",
                "timezone": "America/Montevideo",
                "latitude": -34.9014,
                "longitude": -54.9516
              },
              "pageInfo": {
                "url": "https://nat-pets.com/thank-you",
                "title": "8 Recetas Naturales para Perros - Transforma su Salud en 30 Días",
                "referrer": "direct"
              },
              "userBehavior": {
                "sessionStartTime": "2025-07-24T23:30:38.087Z",
                "referrer": "direct",
                "initialUrl": "https://nat-pets.com/",
                "initialTitle": "8 Recetas Naturales para Perros - Transforma su Salud en 30 Días"
              }
            },
            "events": [
              {
                "eventType": "session_event",
                "metadata": {},
                "createdAt": "2025-07-24T23:30:38.193Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_interaction",
                "metadata": {
                  "elementClass": "px-3 py-1.5 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md transition-colors",
                  "elementTag": "button",
                  "elementText": "Aceptar todo",
                  "actionType": "click",
                  "category": "",
                  "position": {
                    "x": 1280,
                    "y": 930
                  },
                  "isExitLink": false,
                  "visibleTime": 0,
                  "timestamp": "2025-07-24T23:30:39.389Z"
                },
                "createdAt": "2025-07-24T23:30:39.389Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_interaction",
                "metadata": {
                  "elementClass": "bg-orange-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-orange-600 transition duration-300 transform hover:scale-105 flex items-center justify-center gap-2",
                  "elementTag": "button",
                  "elementText": "COMPRAR AHORA POR $15",
                  "actionType": "hover",
                  "category": "",
                  "position": {
                    "x": 519,
                    "y": 760
                  },
                  "isExitLink": false,
                  "parentSection": "header"
                },
                "createdAt": "2025-07-24T23:30:39.945Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_activity",
                "metadata": {
                  "timeOnPage": 2.004,
                  "scrollPercentage": 20,
                  "visibleScrollZones": [
                    "0-10",
                    "10-20"
                  ],
                  "mousePosition": {
                    "x": 519,
                    "y": 775
                  }
                },
                "createdAt": "2025-07-24T23:30:40.091Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_interaction",
                "metadata": {
                  "elementClass": "bg-orange-500 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:bg-orange-600 transition duration-300 transform hover:scale-105 flex items-center justify-center gap-2",
                  "elementTag": "button",
                  "elementText": "COMPRAR AHORA POR $15",
                  "actionType": "click",
                  "category": "",
                  "position": {
                    "x": 519,
                    "y": 775
                  },
                  "isExitLink": false,
                  "parentSection": "header",
                  "visibleTime": 2724,
                  "timestamp": "2025-07-24T23:30:40.494Z"
                },
                "createdAt": "2025-07-24T23:30:40.494Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_interaction",
                "metadata": {
                  "elementId": "name",
                  "elementClass": "w-full px-5 py-4 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-gray-900 bg-white",
                  "elementTag": "input",
                  "actionType": "click",
                  "category": "form",
                  "position": {
                    "x": 1003,
                    "y": 388
                  },
                  "isExitLink": false,
                  "parentSection": "main_content",
                  "visibleTime": 0,
                  "timestamp": "2025-07-24T23:30:42.051Z"
                },
                "createdAt": "2025-07-24T23:30:42.051Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_activity",
                "metadata": {
                  "timeOnPage": 4.013,
                  "scrollPercentage": 90,
                  "visibleScrollZones": [
                    "70-80",
                    "80-90"
                  ],
                  "mousePosition": {
                    "x": 1002,
                    "y": 393
                  }
                },
                "createdAt": "2025-07-24T23:30:42.100Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_interaction",
                "metadata": {
                  "elementId": "name",
                  "elementClass": "w-full px-5 py-4 rounded-lg border border-gray-300 focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-gray-900 bg-white",
                  "elementTag": "input",
                  "actionType": "click",
                  "category": "form",
                  "position": {
                    "x": 1024,
                    "y": 393
                  },
                  "isExitLink": false,
                  "parentSection": "main_content",
                  "visibleTime": 0,
                  "timestamp": "2025-07-24T23:30:42.683Z"
                },
                "createdAt": "2025-07-24T23:30:42.683Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_activity",
                "metadata": {
                  "timeOnPage": 6.007,
                  "scrollPercentage": 90,
                  "visibleScrollZones": [
                    "70-80",
                    "80-90"
                  ],
                  "mousePosition": {
                    "x": 996,
                    "y": 398
                  }
                },
                "createdAt": "2025-07-24T23:30:44.094Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_activity",
                "metadata": {
                  "timeOnPage": 8.01,
                  "scrollPercentage": 90,
                  "visibleScrollZones": [
                    "70-80",
                    "80-90"
                  ],
                  "mousePosition": {
                    "x": 996,
                    "y": 398
                  }
                },
                "createdAt": "2025-07-24T23:30:46.097Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_activity",
                "metadata": {
                  "timeOnPage": 12.005,
                  "scrollPercentage": 90,
                  "visibleScrollZones": [
                    "70-80",
                    "80-90"
                  ],
                  "mousePosition": {
                    "x": 1164,
                    "y": 630
                  }
                },
                "createdAt": "2025-07-24T23:30:50.092Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_interaction",
                "metadata": {
                  "elementClass": "w-full bg-gray-100 text-gray-700 font-bold py-4 px-6 rounded-lg hover:bg-gray-200 transition duration-300 flex items-center justify-center",
                  "elementTag": "button",
                  "actionType": "click",
                  "category": "form",
                  "position": {
                    "x": 1164,
                    "y": 630
                  },
                  "isExitLink": false,
                  "parentSection": "main_content",
                  "visibleTime": 9151,
                  "timestamp": "2025-07-24T23:30:50.214Z"
                },
                "createdAt": "2025-07-24T23:30:50.214Z",
                "pageUrl": "https://nat-pets.com/"
              },
              {
                "eventType": "user_activity",
                "metadata": {
                  "timeOnPage": 14.005,
                  "scrollPercentage": 90,
                  "visibleScrollZones": [
                    "0-100"
                  ],
                  "mousePosition": {
                    "x": 991,
                    "y": 610
                  }
                },
                "createdAt": "2025-07-24T23:30:52.092Z",
                "pageUrl": "https://nat-pets.com/thank-you"
              },
              {
                "eventType": "session_event",
                "metadata": {
                  "reason": "page_leave",
                  "finalAttentionMap": {
                    "0-10": 3,
                    "10-20": 3,
                    "60-70": 1,
                    "70-80": 11,
                    "80-90": 11,
                    "0-100": 1
                  },
                  "duration": 15.013,
                  "scrollPercentage": 100
                },
                "createdAt": "2025-07-24T23:30:53.100Z",
                "pageUrl": "https://nat-pets.com/thank-you"
              }
            ]
          }
        },
        "webhookUrl": "http://0.0.0.0:5678/webhook/visitor-processor",
        "executionMode": "production"
      }
    ]
  },
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "334c1bc3f59651ead42f7f75537ccd47cfce8a8ad7f9b6a1f410e3671bf8aecf"
  }
}